---
title: "Advanced statistics for physics analysis - Exercise 5"
author: "Matteo Bortoletto, matr. 1242935"
date: "05/05/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exercise 1

A publishing company has recently launched a new journal. In order to determine how effective it is in reaching its possible audience, a market survey company selects a random sample of people from a possible target audience and interviews them. Out of 150 interviewed people, 29 have read the last issue of the journal.

a. What kind of distribution would you assume for $y$, the number of people that have seen the last issue of the journal?

I assume that the distribution is the binomial one:

$$
P(r|p,n,M) = \binom{n}{r}p^r(1-p)^{n-r}
$$

b. Assuming a uniform prior, what is the posterior distribution for $y$?

The posterior is given by

$$
P(p|n,r,M) = \frac{1}{Z}p^r(1-p)^{n-r}
$$
where

$$
Z = \sum_{j} p_j^r(1-p_j)^{n-r}\Delta p_j
$$

c. Plot both posterior and likelihood ditributions functions.

```{r}
n <- 150
r <- 29
p <- seq(0, 1, length.out = 201) 
likelihood <- dbinom(x=r, size=n, prob=p)
plot(p, likelihood, 
     col = "deepskyblue3", 
     lwd = 1.5,
     type = "l", 
     xlab = "p", 
     ylab = "P(r|n,r,M)",
     main = "Likelihood")

n.sample <- 2000 # number of intervals in which we divide [0,1] 
delta.p <- 1/n.sample # sub-intervals length
p <- seq(from=1/(2*n.sample), by=1/n.sample, length.out=n.sample)

post.star <- dbinom(x=r, size=n, prob=p) 
post.norm <- post.star/(delta.p*sum(post.star)) 

plot(p, post.norm, 
     type = "l", 
     lwd = 1.5, 
     col = "deepskyblue3", 
     xlim = c(0,1), 
     ylim = c(0,1.1*max(post.norm)), 
     xlab = "p", 
     ylab = "P(p|r,n,M)",
     main = paste("Posterior with uniform prior, r =", r)) 
```


## Exercise 2

Three students want to construct their prior probability about the proportion of residents that support the building of a new concert hall in their small town. Anna thinks that her prior is a beta distribution with mean 0.2 and a standard deviation of 0.08. Benny moved only recently to this new town and therefore he does non have the slightest idea about it. Therefore he decides to use a uniform prior. Chris believes that his prior should have a trapezoidal shape:

$$
f(x) = 
\begin{cases}
20x & 0\le x <0.1 \\
2 & 0.1\le x <0.3 \\
5-10x & 0.3\le x <0.5 \\
0 & x\ge 0.5
\end{cases}
$$

a. Draw and compare the three prior distributions.
```{r}
p <- seq(0, 1, length.out = 201) 
alpha <- 0.2
beta <- 0.08 # GIUSTO? <--------------------------------------------
anna.prior <- function(p, alpha, beta) {
  return(dbeta(p, alpha, beta))
}

benny.prior <- dunif(p)

chris.prior <- function(x){
  prior.v <- ifelse(x >= 0 & x < 0.1, 20*p, 
                    ifelse(x >= 0.1 & x < 0.3, 2,
                           ifelse(x >= 0.3 & x < 0.5, 5-10*x, 0)))
  return(prior.v)
}

plot(p, anna.prior(p, alpha, beta),
     ylim = c(0,3),
     lwd=1.5,
     type = "l",
     xlab = "p",
     ylab = "Prior",
     col = "deepskyblue3",
     main = "Prior distributions")

lines(p, benny.prior,
      lwd=1.5,
      type = "l",
      col = "springgreen3")

lines(p, chris.prior(p),
      lwd=1.5,
      type = "l",
      col = "indianred3")

legend("topright", 
       c("Anna", "Benny", "Chris"), 
       lwd = 3, 
       col = c("deepskyblue3", "springgreen3", "indianred3"))
```

The next day the three students decide to interview a sample of 100 citizens of the small town, asking for their opinion. Out of the interviewed sample, 26 support the building of the new concert hall.

b. Evaluate and draw the three prior distributions.
```{r}
plot(p, anna.prior(p, alpha = 0.26, beta = beta),
     ylim = c(0,3),
     lwd=1.5,
     type = "l",
     xlab = "p",
     ylab = "Prior",
     col = "deepskyblue3",
     main = "Prior distributions after the interview")

lines(p, benny.prior,
      lwd=1.5,
      type = "l",
      col = "springgreen3")

lines(p, seq(chris.prior(0.26), chris.prior(0.26), length.out = 201),
      lwd = 1.5,
      type = "l",
      col = "indianred3")

legend("topright", 
       c("Anna", "Benny", "Chris"), 
       lwd = 3, 
       col = c("deepskyblue3", "springgreen3", "indianred3"))
```

c. Give an estimate of the most probable value and the 95% credibility interval.
```{r}
# for a uniform distribution p0 = r/n and sigma = sqrt(r*(n-r)/n)/n
# for a beta prior p0 = (r+alpha-1)/(n+alpha+beta-2) and sigma = sqrt((alpha+r-1)/(alpha+r))/(alpha+beta+n-2)
# the 95% credibility interval is given by 3*sigma
```

## Exercise 3
A coin is flipped n = 30 times with the following outcomes:
`T, T, T, T, T, H, T, T, H, H, T, T, H, H, H, T, H, T, H, T, H, H, T, H, T, H, T, H,
H, H`

a. Assuming a flat prior, and a beta prior, plot the likelihood, prior and posterior distributions for the data set.
```{r}
n <- 30
r <- 15  # heads
p <- seq(0, 1, length.out = 201)

likelihood <- dbinom(x=r, size=n, prob=p)
plot(p, likelihood, 
     col = "deepskyblue3", 
     lwd = 1.5,
     type = "l", 
     xlab = "p", 
     ylab = "P(r|n,r,M)",
     main = "Likelihood")

flat.prior <- dunif(p)

alpha.p <- 0.5 # assume a fair coin
beta.p <- 0.08
beta.prior <- dbeta(p, alpha.p, beta.p)

plot(p, beta.prior,
     col = "indianred3", 
     type= "l", 
     lty = 1, 
     lwd = 1.5, 
     xlab = "p",
     ylab = "P(p|M)",
     main = "Priors")

lines(p, flat.prior,
     col = "deepskyblue3", 
     type= "l", 
     lty = 1, 
     lwd = 1.5)

legend("topleft", 
       c("Beta prior", "Uniform prior"), 
       lwd = 3, 
       col = c("indianred3", "deepskyblue3"))

n.sample <- 2000 # number of intervals in which we divide [0,1] 
delta.p <- 1/n.sample # sub-intervals length
p <- seq(from=1/(2*n.sample), by=1/n.sample, length.out=n.sample)
post.star.u <- dbinom(x=r, size=n, prob=p)
post.norm.u <- post.star.u/(delta.p*sum(post.star.u))
plot(p, post.norm.u,
     type = "l", 
     lwd = 1.5, 
     col = "deepskyblue3",
     ylim = c(0, 1.1*max(post.norm.u)),
     xlab = "p", 
     ylab = "P(p|r,n,M)",
     main = paste("Posteriors, r =", r)) 

alpha <- alpha.p + r 
beta <- beta.p + n - r 
post.star.b <- dbeta(p, alpha, beta)
post.norm.b <- post.star.b/(delta.p*sum(post.star.b))
lines(p, post.norm.b,
     type = "l", 
     lwd = 1.5, 
     col = "indianred3",
     #ylim=c(0,1.1*max(post.norm.b)),
     xlab = "p", 
     ylab = "P(p|r,n,M)")
     #main=paste("Posterior with beta prior, r =",r)) 

legend("topleft", 
       c("Beta prior", "Uniform prior"), 
       lwd = 3, 
       col = c("indianred3", "deepskyblue3"))
```

b. Evaluate the most probable value for the coin probability $p$ and, integrating the posterior probability distribution, give an estimate for a 95% credibility interval.
```{r}
p0.u <- r/n
cat("UNIFORM PRIOR - The most probable value for the coin probability p is:", p0.u, "\n")

sigma.u <- sqrt(r*(n-r)/n)/n
cred.int.95.u <- 3*sigma.u
cat("UNIFORM PRIOR - The 95% credibility interval is:", cred.int.95.u, "\n")

p0.b <- (r+alpha-1)/(n+alpha+beta-2)
cat("BETA PRIOR - The most probable value for the coin probability p is:", p0.b, "\n")

sigma.b <- sqrt((alpha+r-1)/(alpha+r))/(alpha+beta+n-2)
cred.int.95.b <- 3*sigma.b
cat("BETA PRIOR - The 95% credibility interval is:", cred.int.95.b)
```

c. Repeat the same analysis assuming a sequential analysis of the data. Show how the most probable value and the credibility interval change as a function of the number of coin tosses (i.e. from 1 to 30).
```{r}

```

d. Do you get a different result, by analyzing the data sequentially with respect to a one-step analysis (i.e. considering all the data as a whole)?
```{r}

```